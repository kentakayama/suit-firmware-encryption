name: Validating SUIT Encrypted Payloads examples
on: pull_request

jobs:
  cddl-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2' # Not needed with a .ruby-version file
        bundler-cache: true # runs 'bundle install' and caches installed gems automatically
    - run: gem install cbor-diag
    - run: gem install cddl -v 0.10.3
    - uses: actions/setup-python@v4
    - run: python -m pip install cwt>=2.7.0
    - run: sudo apt-get update && sudo apt-get install -y xxd
    - name: Vaildate examples
      run: make -C examples/ validate
    - name: Upload *.suit files
      uses: actions/upload-artifact@v4
      with:
        name: suit-encrypted-payloads
        path: |
          ./examples/suit-manifest-aes-kw-content.suit
          ./examples/suit-manifest-aes-kw.suit
          ./examples/suit-manifest-aes-kw-slot.suit
          ./examples/suit-manifest-es-ecdh-content.suit
          ./examples/suit-manifest-es-ecdh-dependency.suit
  parse-test:
    runs-on: ubuntu-latest
    needs: cddl-test
    steps:
    - name: Download *.suit files
      uses: actions/download-artifact@v4
      with:
        name: suit-encrypted-payloads
    - name: Build parsers
      run: |
        sudo apt-get install -y git make gcc libssl-dev
        git clone --depth 1 https://github.com/laurencelundblade/QCBOR.git
        sudo make -C QCBOR install
        git clone --depth 1 --branch dev https://github.com/laurencelundblade/t_cose.git
        sudo make -C t_cose -f Makefile.ossl install
        git clone --depth 1 https://github.com/kentakayama/libcsuit.git
        make -C libcsuit -f Makefile.parser
        make -C libcsuit -f Makefile.process
    - name: Run
      run: |
        ./libcsuit/bin/suit_manifest_parser ./examples/suit-manifest-aes-kw-content.suit
        ./libcsuit/bin/suit_manifest_process ./examples/suit-manifest-aes-kw-content.suit
        ./libcsuit/bin/suit_manifest_parser ./examples/suit-manifest-aes-kw.suit
        ./libcsuit/bin/suit_manifest_process ./examples/suit-manifest-aes-kw.suit
        ./libcsuit/bin/suit_manifest_parser ./examples/suit-manifest-aes-kw-slot.suit
        ./libcsuit/bin/suit_manifest_process ./examples/suit-manifest-aes-kw-slot.suit
        ./libcsuit/bin/suit_manifest_parser ./examples/suit-manifest-es-ecdh-content.suit
        ./libcsuit/bin/suit_manifest_process ./examples/suit-manifest-es-ecdh-content.suit
        ./libcsuit/bin/suit_manifest_parser ./examples/suit-manifest-es-ecdh-dependency.suit
        ./libcsuit/bin/suit_manifest_process ./examples/suit-manifest-es-ecdh-dependency.suit
